#!/bin/bash
#
# tcos helper utility to:
# - build
# - upload
#
# Copyright (C) 2014 openthinclient GmbH All Rights Reserved.
#
# Author: Steffen HÃ¶nig
#
#

# includes

. /usr/share/tcos-dev/functions/ini_parser
. /usr/share/tcos-dev/functions/usage

VERSION=0.1
ARCH=i386


# config file: ~/.tcosconfig > /etc/tcos-dev/tcosconfig

[ -f ~/.tcosconfig ] && INI_FILE="~/.tcosconfig" || INI_FILE="/etc/tcos-dev/tcosconfig"

function config() {

    while [ "$#" -ge 1 ];do
	case $1 in
	    get)
		shift
		if [ "$1" = "--server" ];then
		    section="$1"
		    shift
		else
		    section=$(default_section $ini_file)
		fi
		# read the ini file and load the variablesinto the current namespace
		eval $(read_section $ini_file $section)

		if "$1";then
		    set | grep -i "$1"
		else
		    set
		fi
		;;
	    set)
		shift
		#todo:
		;;
	    *)
		#todo
		;;
	esac
    done


exit 65
}

function build() {
    fakeroot=""
    build_args=""

    while [ "$#" -ge 1 ];do
    	case $1 in
	    --base)
		shift
		fakeroot="-rsudo"
		;;
	    --test)
		shift
		#todo
		;;
	    .)
		shift
		;;
	    *)
		shift
		build_args="${build_args} ${key}"
		;;
	esac
    done
    dpkg-buildpackage ${fakeroot} -us -uc -a${ARCH} $build_args
    # copy changelog
    package_name=$(head -1 debian/changelog | awk '{print $1}')
    if [ "$package_name" ]; then
	cp debian/changelog ../"$package_name".changelog
    fi

    exit 0
}

function update_metadata() {
    remote=$1
    path=$2
    prefix=$3

    #private or public repo? look for --hash
    if [ "$hash"];then
	ssh_path="$path/${prefix}_$hash"
	echo -e "Insert the following line to your sources.list:\ndeb ${remote}/${prefix}_${HASH} ./\n"
    else
	ssh_path="$path"
    ssh $remote "cd $ssh_path; apt-ftparchive packages . > Packages; gzip -9cf < Packages > Packages.gz ; \
			       bzip2 -9cf < Packages > Packages.bz2; \
			       apt-ftparchive sources . > Sources; gzip -9cf < Sources > Sources.gz; \
			       bzip2 -9cf < Sources > Sources.bz2; \
			       apt-ftparchive release . > Release \
	        "
    fi
}

function upload_file() {
    remote=$1
    path=$2
    file=$3
    prefix=$4

    #private or public repo? look for --hash
    if [ "$hash" ];then
	# stream the file over a pipe to ssh
	cat $file | ssh $remote "mkdir -p $path/${prefix}_$hash; cat >> $path/${prefix}_$hash/`basename $file`"
    else
	cat $file | ssh $remote "cat >> $path/$(basename $file)"
    fi
}

function upload() {
   set -x
   upload_args=""
   while [ "$#" -ge 1 ];do
      case $1 in
	  --server)
	      shift
	      #parses config file -> dir, remote
	      eval $(read_section $ini_file $1)
	      ;;
	  --hash)
	      shift
	      hash="$1"
	      ;;
	  *)
	      upload_args="${upload_args} ${1}"
	      shift
	      ;;
      esac
  done
  debs=${upload_args}
  for d in $debs;do
      if echo $d | /bin/grep -qs "\.deb$";then
	  bn=$(basename $d)
	  dn=$(dirname $d)
	  base=${bn%%_*b}
	  changelog=${dn}/${base}.changelog
	  version=$(grep -m 1 -i $base $changelog | awk '{print $2}' | tr -d '()')
	  changes=${dn}/${base}_${version}_${ARCH}.changes
	  dsc=${dn}/${base}_${version}.dsc
	  tgz=${dn}/${base}_${version}.tar.gz
	  echo -e "Uploading:\n"
	  for f in $d $dsc $changes $changelog $tgz;do
	      echo -e "--> $f\n"
	      upload_file $remote $dir $f $base
	  done
	  echo -e "Generating: Packages.gz\n"
	  update_metadata $remote $dir $base
      fi
  done
  set +x
}

# build or upload? (or config?)

key="$1"

case $key in
    build)
	shift
	[ -z "$1" ] && usage_build
	build "$@"
	;;
    config)
	shift
	[ -z "$1" ] && usage_config
	;;
    upload)
	shift
	[ -z "$1" ] && usage_upload
	upload "$@"
	;;
    -v|--version|version)
	echo -e "$(basename $0) utility. version: $VERSION"
	exit 65
	;;
    *)
	usage
	;;
esac
